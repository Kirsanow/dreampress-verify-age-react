const e="uvae-token";const t=new class{constructor(){this._jwk={alg:"PS256",e:"AQAB",kty:"RSA",n:"oZcuAKQFI3jGMXr6hjGyshDYD-msQuvuMm6ytVYbKci9pwIpEAyErulo_KcYR3jQkX-BDkTF-3bxKuIRfIe1fAyOTDyQIvIpvJfymmSudL-Uu0eOTb3GEkewPRVBo1jyKu5q3HY0bAX8lPCsXJ0X3QJfb6COhm1rOJcMUmv18ryZgauvQ18w9ZmP4yPtqW4jh4jLuPoHaFex_zHO9T6a1fDDnx1rk1ircHkVii8DViAkFf9O65SasZOcXkWuVrjWIivGMHg_lVwxwksmNqPa6pBdmdfAhljF63hYeP7ska1RuDCwaWNNVcqq1LFyUEV7Hdf88lQeozCi6Z8Cv7l1qQ",use:"sig"}}async estimateAge(t={}){const a=localStorage.getItem(e);if(a)if(t.enableCache)try{let t=await this.verifyToken(a);if(t)return t.age;localStorage.removeItem(e)}catch(t){localStorage.removeItem(e)}else localStorage.removeItem(e);return new Promise((async(a,r)=>{let n=!1;const o=Math.random().toString(36).substring(2,15),i=t.localTesting?"../index.html":"https://universal-verify.github.io/age-estimator/",c=t.localTesting?window.location.origin:"https://universal-verify.github.io",s=t.livenessCheck||!1,l=t.cacheDuration||864e5,u=window.open(i,"_blank");if(!u)return void r("POPUP_BLOCKED");function cleanup(){window.removeEventListener("message",handler),clearInterval(g)}const handler=async i=>{if(i.source===u&&i.origin===c)if("age-estimation-result"===i.data.type){if(i.data.nonce!==o)return;n=!0;try{await this.verifyToken(i.data.token)?(t.enableCache&&localStorage.setItem(e,i.data.token),a(i.data.age)):r("INVALID_SIGNATURE")}catch(e){r("INVALID_SIGNATURE")}u.close(),cleanup()}else if("age-estimation-error"===i.data.type){if(i.data.nonce!==o)return;n=!0,i.data.error.includes("webcam")?r("WEBCAM_ERROR"):i.data.error.includes("Different face")?r("DIFFERENT_FACE_ERROR"):r("INTERNAL_ERROR"),u.close(),cleanup()}else if("check-parent-commandeer"===i.data.type){let e=window.location.origin;u.postMessage({type:"confirm-parent-commandeer",nonce:o,livenessCheck:s,cacheDuration:l,origin:e},e)}};window.addEventListener("message",handler);const g=setInterval((()=>{u.closed&&!n&&(n=!0,r("CANCELLED"),cleanup())}),500)}))}clearCache(){localStorage.removeItem(e)}async getCachedAge(){const t=localStorage.getItem(e);if(t)try{let a=await this.verifyToken(t);if(a)return a.age;localStorage.removeItem(e)}catch(t){localStorage.removeItem(e)}return null}getCachedToken(){return localStorage.getItem(e)||null}async verifyToken(e){const t=await crypto.subtle.importKey("jwk",this._jwk,{name:"RSA-PSS",hash:"SHA-256"},!1,["verify"]),[a,r]=e.split("."),n=JSON.parse(atob(a));if(n.exp<Date.now())throw new Error("EXPIRED");if(n.sub!==function(e){let t=0;for(let a=0;a<e.length;a++)t=(t<<5)-t+e.charCodeAt(a),t|=0;return t}(navigator.userAgent+window.location.origin))throw new Error("INVALID_SUB");if(!await crypto.subtle.verify({name:"RSA-PSS",saltLength:32},t,function(e){const t=new Uint8Array(e.length/2);for(let a=0;a<e.length;a+=2)t[a/2]=parseInt(e.substr(a,2),16);return t.buffer}(r),(new TextEncoder).encode(a)))throw new Error("INVALID_SIGNATURE");return n}};export{t as default};
